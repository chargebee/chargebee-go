//go:build ignore

//go:generate go run gen_client.go

package main

import (
	"bytes"
	"fmt"
	"go/format"
	"log"
	"os"
	"path/filepath"
	"regexp"
	"sort"
	"strings"
)

func main() {
	// Find all *_service.go files in the current directory
	files, err := filepath.Glob("*_service.go")
	if err != nil {
		log.Fatalf("failed to glob service files: %v", err)
	}

	// Regex to extract service type names like "CustomerService"
	serviceTypeRegex := regexp.MustCompile(`type\s+(\w+Service)\s+struct`)

	var services []string
	for _, file := range files {
		content, err := os.ReadFile(file)
		if err != nil {
			log.Fatalf("failed to read %s: %v", file, err)
		}

		matches := serviceTypeRegex.FindAllStringSubmatch(string(content), -1)
		for _, match := range matches {
			if len(match) > 1 {
				services = append(services, match[1])
			}
		}
	}

	// Sort for consistent output
	sort.Strings(services)

	// Generate the code
	var buf bytes.Buffer
	buf.WriteString("// Code generated by gen_client.go; DO NOT EDIT.\n\n")
	buf.WriteString("package chargebee\n\n")

	// Generate Client struct
	buf.WriteString("type Client struct {\n")
	buf.WriteString("\tconfig *ClientConfig\n\n")
	for _, svc := range services {
		fieldName := strings.TrimSuffix(svc, "Service")
		buf.WriteString(fmt.Sprintf("\t%s *%s\n", fieldName, svc))
	}
	buf.WriteString("}\n\n")

	// Generate NewClient constructor
	buf.WriteString("func NewClient(config *ClientConfig) *Client {\n")
	buf.WriteString("\treturn &Client{\n")
	buf.WriteString("\t\tconfig: config,\n")
	for _, svc := range services {
		fieldName := strings.TrimSuffix(svc, "Service")
		buf.WriteString(fmt.Sprintf("\t\t%s: &%s{config: config},\n", fieldName, svc))
	}
	buf.WriteString("\t}\n")
	buf.WriteString("}\n")

	// Format the generated code
	formatted, err := format.Source(buf.Bytes())
	if err != nil {
		log.Fatalf("failed to format generated code: %v", err)
	}

	// Write to client.go
	if err := os.WriteFile("client.go", formatted, 0644); err != nil {
		log.Fatalf("failed to write client.go: %v", err)
	}

	fmt.Printf("Generated client.go with %d services\n", len(services))
}
